<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.09 (Pod::Simple 3.04, Perl::Tidy 20070508) on 2008-12-05 22:18:12 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2008 Perl Advent Calendar: Better not fault, better not die()</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="5.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2008-12</a>-05</h1>
<h2 align="center">Better not fault, better not die()</h2>
<h3 align="center">by Yanick Champoux</h3>
<p>Everyone knows about Santa's Naughty or Nice list. Few lists are more revered, nor feared, than this one. For some of us, it led to the most wonderful surprises and cherished childhood memories. For others... well, let's just say that it was instrumental in the stockpiling of enough fossil fuel to keep us warm throughout the winter (and then some).</p>
<p>What few people know, though, is that the List stopped being scalable many years ago. With so many kids, and the Niceness matrix constantly growing in complexity, it was only a question of time before the North Pole scribes would lose the fight. So, once it became clear that the good ol' ways wouldn't do anymore, the big Ho-Ho-Honcho put his foot down and mandated the IT elves to overhaul the whole process.</p>
<p>And they did. As it turned out, they elected to base their solution on <tt><a href="http://search.cpan.org/search?module=Test::Harness">Test::Harness</a></tt> and the whole Perl testing infrastructure. In the span of a few months, through the sheer might of their merry hacking, they turned the quaint paper-based list of yore into a lean, mean, database server farm-backed machine. Now, the dirt could be gathered on all the children in the blink of an eye:</p>
<pre><span class="c">    ok 1 - Li'l Timmy has been nice
    ok 2 - Li'l Timmy ate his/her veggies
    ok 3 - Li'l Timmy off to bed before 19:30
    ok 4 - Li'l Timmy has not been pouting
    ok 5 - Li'l Timmy has not been grouchy
    not ok 6 - Li'l Dennis has been nice
    not ok 7 - Li'l Dennis ate his/her veggies
    ok 8 - Li'l Dennis off to bed before 19:30
    ok 9 - Li'l Dennis has not been pouting
    ok 10 - Li'l Dennis has not been grouchy
    ok 11 - Li'l Linus has been nice
    ok 12 - Li'l Linus ate his/her veggies
    ok 13 - Li'l Linus off to bed before 19:30
    ok 14 - Li'l Linus has not been pouting
    ok 15 - Li'l Linus has not been grouchy
    ok 16 - Li'l Lucy has been nice
    ok 17 - Li'l Lucy ate his/her veggies
    ok 18 - Li'l Lucy off to bed before 19:30
    ok 19 - Li'l Lucy has not been pouting
    not ok 20 - Li'l Lucy has not been grouchy</span></pre>
<p>Pretty proud of their system, the elves went and presented it to the Big Man. Unfortunately, and as it is well-documented in songs, Santa's a busy man he has no time to play. And having millions of stockings to fill on Christmas day makes one a firm believer in executive summaries. So it's understandable that Father Christmas wasn't totally sold to the elves' solution. "I don't care if they're sleeping," he snapped, "I don't care if they're awake, I just want to know if they've been good, FOR GOODNESS' SAKE!"</p>
<p>Back to the drawing board the elves scurried. Would they have to rewrite their infrastructure from scratch? Could this unforeseen churn jeopardize Christmas' delivery date? It turned out they didn't need to, and -- heavens be thanked -- it wouldn't. For one of the lead develfpers thought of using <tt><a href="http://search.cpan.org/search?module=Test::Group">Test::Group</a></tt> to bundle each child's tests into a single all-niceness-encompassing one.</p>
<pre><span class="c">    ok 1 - Li'l Timmy
    not ok 2 - Li'l Dennis
    ok 3 - Li'l Linus
    not ok 4 - Li'l Lucy</span></pre>
<p>This was much more to Santa's liking and, boys and girls, this is still the system that the North Pole use to this very day...</p>
<blockquote style="padding: 1em; border: 2px ridge black; background-color:#eee"><p>Note to kiddies for 2008/2009 -- Bedtime niceness is an Average. Going to bed at sundown may save it at the last minute. Niceness and bedtime have some slack but vegetables, grouchy, pouting are seemingly Zero tolerance, so be careful! -- The Mgt</p>
</blockquote>
<h2>Before</h2>
<a name="mod5a.pl" id="mod5a.pl"></a><h2><a href="mod5a.pl">mod5a.pl</a></h2><pre>
   1 <span class="k">use</span> <span class="w">Test::More</span> <span class="q">&#39;no_plan&#39;</span><span class="sc">;</span>
   2 
   3 <span class="k">use</span> <span class="w">ChildrenDB</span><span class="sc">;</span>
   4 
   5 <span class="k">while</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$kid</span> = <span class="i">ChildrenDB::next_child</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
   6     <span class="k">my</span> <span class="i">$who</span> = <span class="q">&quot;Li&#39;l &quot;</span> . <span class="i">$kid</span><span class="i">-&gt;name</span><span class="sc">;</span>
   7 
   8     <span class="w">ok</span> <span class="i">$kid</span><span class="i">-&gt;nice_level</span> &gt;= <span class="n">5</span><span class="cm">,</span>    <span class="q">&quot;$who has been nice&quot;</span><span class="sc">;</span>
   9     <span class="w">ok</span> <span class="i">$kid</span><span class="i">-&gt;eat_vegetables</span><span class="cm">,</span>     <span class="q">&quot;$who ate his/her veggies&quot;</span><span class="sc">;</span>
  10     <span class="w">ok</span> <span class="i">$kid</span><span class="i">-&gt;avg_bedtime</span> &lt; <span class="n">1930</span><span class="cm">,</span> <span class="q">&quot;$who off to bed before 19:30&quot;</span><span class="sc">;</span>
  11     <span class="w">ok</span> !<span class="i">$kid</span><span class="i">-&gt;been_pouting</span><span class="cm">,</span>      <span class="q">&quot;$who has not been pouting&quot;</span><span class="sc">;</span>
  12     <span class="w">ok</span> !<span class="i">$kid</span><span class="i">-&gt;been_grouchy</span><span class="cm">,</span>      <span class="q">&quot;$who has not been grouchy&quot;</span><span class="sc">;</span>
  13 <span class="s">}</span>
  14 
</pre>
<h2>After</h2>
<a name="mod5b.pl" id="mod5b.pl"></a><h2><a href="mod5b.pl">mod5b.pl</a></h2><pre>
   1 <span class="k">use</span> <span class="w">Test::More</span> <span class="q">&#39;no_plan&#39;</span><span class="sc">;</span>
   2 
   3 <span class="k">use</span> <span class="w">ChildrenDB</span><span class="sc">;</span>
   4 
   5 <span class="k">use</span> <span class="w">Test::Group</span><span class="sc">;</span>
   6 
<a name="been_good"></a>   7 <span class="k">sub </span><span class="m">been_good($)</span> <span class="s">{</span>
   8     <span class="k">my</span> <span class="i">$kid</span> = <span class="k">shift</span><span class="sc">;</span>
   9     <span class="w">test</span> <span class="q">&quot;Li&#39;l &quot;</span> . <span class="i">$kid</span><span class="i">-&gt;name</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
  10         <span class="w">ok</span> <span class="i">$kid</span><span class="i">-&gt;nice_level</span> &gt;= <span class="n">5</span><span class="cm">,</span>    <span class="q">&#39;has been nice&#39;</span><span class="sc">;</span>
  11         <span class="w">ok</span> <span class="i">$kid</span><span class="i">-&gt;eat_vegetables</span><span class="cm">,</span>     <span class="q">&#39;ate his/her veggies&#39;</span><span class="sc">;</span>
  12         <span class="w">ok</span> <span class="i">$kid</span><span class="i">-&gt;avg_bedtime</span> &lt; <span class="n">1930</span><span class="cm">,</span> <span class="q">&#39;off to bed before 19:30&#39;</span><span class="sc">;</span>
  13         <span class="w">ok</span> !<span class="i">$kid</span><span class="i">-&gt;been_pouting</span><span class="cm">,</span>      <span class="q">&#39;not been pouting&#39;</span><span class="sc">;</span>
  14         <span class="w">ok</span> !<span class="i">$kid</span><span class="i">-&gt;been_grouchy</span><span class="cm">,</span>      <span class="q">&#39;not been grouchy&#39;</span><span class="sc">;</span>
  15       <span class="s">}</span>
  16 <span class="s">}</span>
  17 
  18 <span class="k">while</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$kid</span> = <span class="i">ChildrenDB::next_child</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
  19     <span class="i">been_good</span> <span class="i">$kid</span><span class="sc">;</span>
  20 <span class="s">}</span>
</pre>
<h2>DB Mock Object</h2>
<a name="ChildrenDB.pm" id="ChildrenDB.pm"></a><h2><a href="ChildrenDB.pm">ChildrenDB.pm</a></h2><pre>
<a name="package-ChildrenDB"></a>   1 <span class="k">package </span><span class="i">ChildrenDB</span><span class="sc">;</span>
   2 
   3 <span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
   4 <span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
   5 
   6 <span class="c"># mock-up of the North Pole children database</span>
   7 <span class="c"># which can&#39;t be reproduced here (as it&#39;s top-secret</span>
   8 <span class="c"># material)</span>
   9 
  10 <span class="k">my</span> <span class="i">@children</span> = <span class="s">(</span>
  11     <span class="w">Kid</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&#39;Timmy&#39;</span> <span class="s">)</span><span class="cm">,</span>
  12     <span class="w">Kid</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&#39;Dennis&#39;</span><span class="cm">,</span> <span class="w">nice_level</span> <span class="cm">=&gt;</span> <span class="n">2</span><span class="cm">,</span> <span class="w">eat_vegetables</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span> <span class="s">)</span><span class="cm">,</span>
  13     <span class="w">Kid</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&#39;Linus&#39;</span> <span class="s">)</span><span class="cm">,</span>
  14     <span class="w">Kid</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">name</span> <span class="cm">=&gt;</span> <span class="q">&#39;Lucy&#39;</span><span class="cm">,</span> <span class="w">been_grouchy</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="cm">,</span>
  15 <span class="s">)</span><span class="sc">;</span>
  16 
<a name="next_child"></a>  17 <span class="k">sub </span><span class="m">next_child</span> <span class="s">{</span>
  18     <span class="k">return</span> <span class="k">shift</span> <span class="i">@children</span><span class="sc">;</span>
  19 <span class="s">}</span>
  20 
  21 <span class="s">{</span>
  22 
<a name="package-Kid"></a>  23     <span class="k">package </span><span class="i">Kid</span><span class="sc">;</span>
  24 
<a name="new"></a>  25     <span class="k">sub </span><span class="m">new</span> <span class="s">{</span>
  26         <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">%attrs</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  27 
  28         <span class="k">return</span> <span class="k">bless</span> <span class="s">{</span>
  29             <span class="w">nice_level</span>     <span class="cm">=&gt;</span> <span class="n">5</span><span class="cm">,</span>
  30             <span class="w">eat_vegetables</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
  31             <span class="w">avg_bedtime</span>    <span class="cm">=&gt;</span> <span class="n">1900</span><span class="cm">,</span>
  32             <span class="w">been_pouting</span>   <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
  33             <span class="w">been_grouchy</span>   <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
  34             <span class="i">%attrs</span><span class="cm">,</span>
  35         <span class="s">}</span><span class="cm">,</span> <span class="i">$class</span><span class="sc">;</span>
  36 
  37     <span class="s">}</span>
  38 
<a name="AUTOLOAD"></a>  39     <span class="k">sub </span><span class="m">AUTOLOAD</span> <span class="s">{</span>
  40         <span class="k">no</span> <span class="w">strict</span><span class="sc">;</span>
  41         <span class="s">(</span> <span class="k">my</span> <span class="i">$key</span> = <span class="i">$AUTOLOAD</span> <span class="s">)</span> =~ <span class="q">s/^.*:://</span><span class="sc">;</span>
  42         <span class="k">return</span> <span class="i">$_</span>[<span class="n">0</span>]-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
  43     <span class="s">}</span>
<a name="package-ChildrenDB-1"></a>  44 <span class="s">}</span>
  45 
  46 <span class="n">1</span><span class="sc">;</span>
</pre>
<div style="float: right; font-size: 10pt"><a href="5.pod">View Source (POD)</a></div><br />
</body>
</html>
